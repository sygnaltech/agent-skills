#!/usr/bin/env node

/**
 * CLI for generating agent skill files
 */

const { generate, listSources } = require('../src/index');
const { version } = require('../package.json');
const { checkAndUpdate } = require('../src/utils/version-checker');

// Parse command line arguments
const args = process.argv.slice(2);
const command = args[0];
const sources = args.slice(1);

// Command handlers
async function handleGenerate() {
  if (sources.length === 0) {
    console.error('Error: Please specify at least one documentation source');
    const available = await listSources();
    console.log(`Available sources: ${available.map(s => s.name).join(', ')}`);
    console.log('\nUsage: agent-skills learn <source1> [source2] [...]');
    process.exit(1);
  }

  try {
    console.log(''); // Blank line at top
    for (const source of sources) {
      await generate(source);
      if (sources.indexOf(source) < sources.length - 1) {
        console.log(''); // Add blank line between multiple sources
      }
    }
    console.log('\nâœ“ All skills learned successfully\n');
    process.exit(0);
  } catch (err) {
    console.error('Learning failed:', err.message);
    process.exit(1);
  }
}

async function handleList() {
  console.log('Available documentation sources:');
  const sources = await listSources();
  // Calculate padding for alignment
  const maxNameLength = Math.max(...sources.map(s => s.name.length));

  sources.forEach(src => {
    const padding = ' '.repeat(maxNameLength - src.name.length);
    console.log(`  - ${src.name}${padding}  ${src.description}`);
  });
}

function showVersion() {
  console.log(`agent-skills v${version}`);
}

function showHelp() {
  console.log(`
Agent Skills Generator v${version}
==================================

Usage:
  agent-skills learn <source1> [source2] [...]
  agent-skills list
  agent-skills help
  agent-skills --version

Commands:
  learn <sources...>     Learn skills from one or more documentation sources
  list                   List available documentation sources
  help                   Show this help message
  --version, -v          Show version number

Examples:
  agent-skills learn webflow-cloud
  agent-skills learn webflow-cloud webflow-code-components
  agent-skills list
  agent-skills -v
  `);
}

// Main execution with version check
async function main() {
  // Check for updates before running commands (except for version command)
  if (command !== '--version' && command !== '-v') {
    await checkAndUpdate('@sygnal/agent-skills', version, { silent: true });
  }

  // Route commands
  switch (command) {
    case 'learn':
    case 'generate':
      await handleGenerate();
      break;
    case 'list':
      await handleList();
      break;
    case 'help':
    case '--help':
    case '-h':
      showHelp();
      break;
    case '--version':
    case '-v':
      showVersion();
      break;
    default:
      console.error(`Unknown command: ${command || '(none)'}`);
      showHelp();
      process.exit(1);
  }
}

// Run the CLI
main().catch(err => {
  console.error('Unexpected error:', err.message);
  process.exit(1);
});
